name: CI/CD Pipeline

on:
  push:
    branches: [main]
    paths:
      - 'app/**'
      - '.github/workflows/ci-cd.yml'
      - 'charts/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: backstage-beach/${{ values.name }}
  APP_NAME: ${{ values.name }}
  NAMESPACE: ${{ values.namespace }}

jobs:
  build:
    name: Build and Push
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ '${{' }} env.REGISTRY }}
          username: ${{ '${{' }} github.actor }}
          password: ${{ '${{' }} secrets.GITHUB_TOKEN }}

      - name: Generate image tag
        id: image-tag
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)
          BRANCH_NAME="${{ '${{' }} github.ref_name }}"
          # Sanitize branch name
          BRANCH_NAME=$(echo "$BRANCH_NAME" | sed 's/[^a-zA-Z0-9._-]/-/g')
          
          TAGS="${{ '${{' }} env.REGISTRY }}/${{ '${{' }} env.IMAGE_NAME }}:${BRANCH_NAME}-${SHORT_SHA}"
          TAGS="${TAGS},${{ '${{' }} env.REGISTRY }}/${{ '${{' }} env.IMAGE_NAME }}:sha-${SHORT_SHA}"
          
          if [[ "${{ '${{' }} github.ref_name }}" == "main" ]]; then
            TAGS="${TAGS},${{ '${{' }} env.REGISTRY }}/${{ '${{' }} env.IMAGE_NAME }}:latest"
            TAG="main-${SHORT_SHA}"
          else
            TAG="${BRANCH_NAME}-${SHORT_SHA}"
          fi
          
          echo "tags=${TAGS}" >> $GITHUB_OUTPUT
          echo "primary-tag=${TAG}" >> $GITHUB_OUTPUT
          echo "short-sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "build-date=$(date -u +'%Y%m%d')" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        id: build-image
        uses: docker/build-push-action@v5
        with:
          context: app
          push: true
          tags: ${{ '${{' }} steps.image-tag.outputs.tags }}
          labels: |
            org.opencontainers.image.version=${{ '${{' }} steps.image-tag.outputs.primary-tag }}
            org.opencontainers.image.revision=${{ '${{' }} github.sha }}
            org.opencontainers.image.created=${{ '${{' }} steps.image-tag.outputs.build-date }}

      - name: Summary
        run: |
          echo "### ðŸ³ Docker Image Built" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Primary Tag**: \`${{ '${{' }} steps.image-tag.outputs.primary-tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**SHA Tag**: \`sha-${{ '${{' }} steps.image-tag.outputs.short-sha }}\`" >> $GITHUB_STEP_SUMMARY

  deploy:
    name: Deploy to EKS via ArgoCD
    needs: build
    runs-on: ubuntu-latest
    environment: ${{ '${{' }} inputs.environment || 'dev' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install ArgoCD CLI
        run: |
          VERSION=$(curl --silent "https://api.github.com/repos/argoproj/argo-cd/releases/latest" | grep '"tag_name"' | sed -E 's/.*"([^"]+)".*/\1/')
          curl -sSL -o /tmp/argocd-linux-amd64 "https://github.com/argoproj/argo-cd/releases/download/${VERSION}/argocd-linux-amd64"
          sudo install -m 555 /tmp/argocd-linux-amd64 /usr/local/bin/argocd
          rm /tmp/argocd-linux-amd64

      - name: Add Git repository to ArgoCD
        env:
          ARGOCD_SERVER: ${{ '${{' }} secrets.ARGOCD_SERVER }}
          ARGOCD_AUTH_TOKEN: ${{ '${{' }} secrets.ARGOCD_AUTH_TOKEN }}
          GITHUB_TOKEN: ${{ '${{' }} secrets.ARGOCD_GITHUB_TOKEN }}
        run: |
          REPO_URL="https://github.com/backstage-beach/${{ '${{' }} github.event.repository.name }}"
          
          argocd repo add "$REPO_URL" \
            --username git \
            --password "$GITHUB_TOKEN" \
            --insecure-skip-server-verification \
            --upsert \
            --grpc-web

      - name: Create ArgoCD Application
        env:
          ARGOCD_SERVER: ${{ '${{' }} secrets.ARGOCD_SERVER }}
          ARGOCD_AUTH_TOKEN: ${{ '${{' }} secrets.ARGOCD_AUTH_TOKEN }}
        run: |
          REPO_URL="https://github.com/backstage-beach/${{ '${{' }} github.event.repository.name }}"
          
          argocd app create "${{ '${{' }} env.APP_NAME }}" \
            --repo "$REPO_URL" \
            --path "charts/${{ '${{' }} env.APP_NAME }}" \
            --dest-server https://kubernetes.default.svc \
            --dest-namespace "${{ '${{' }} env.NAMESPACE }}" \
            --revision HEAD \
            --sync-policy automated \
            --sync-option CreateNamespace=true \
            --auto-prune \
            --self-heal \
            --upsert \
            --grpc-web

      - name: Sync ArgoCD Application
        env:
          ARGOCD_SERVER: ${{ '${{' }} secrets.ARGOCD_SERVER }}
          ARGOCD_AUTH_TOKEN: ${{ '${{' }} secrets.ARGOCD_AUTH_TOKEN }}
        run: |
          argocd app sync "${{ '${{' }} env.APP_NAME }}" --prune --grpc-web
          argocd app wait "${{ '${{' }} env.APP_NAME }}" --health --timeout 300 --grpc-web

      - name: Verify deployment
        env:
          ARGOCD_SERVER: ${{ '${{' }} secrets.ARGOCD_SERVER }}
          ARGOCD_AUTH_TOKEN: ${{ '${{' }} secrets.ARGOCD_AUTH_TOKEN }}
        run: |
          echo "### ðŸš€ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Application**: \`${{ '${{' }} env.APP_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Namespace**: \`${{ '${{' }} env.NAMESPACE }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ArgoCD**: [View Application](https://${{ '${{' }} secrets.ARGOCD_SERVER }}/applications/${{ '${{' }} env.APP_NAME }})" >> $GITHUB_STEP_SUMMARY
          
          argocd app get "${{ '${{' }} env.APP_NAME }}" --grpc-web
