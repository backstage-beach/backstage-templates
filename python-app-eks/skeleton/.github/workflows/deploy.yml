name: Deploy to EKS

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

permissions:
  contents: read
  id-token: write

env:
  AWS_REGION: sa-east-1
  APP_NAME: ${{ values.name }}
  NAMESPACE: ${{ values.namespace }}

jobs:
  deploy:
    name: Deploy to EKS via ArgoCD
    runs-on: ubuntu-latest
    environment: ${{ "{{" }} inputs.environment {{ "}}" }}
    
    steps:
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install ArgoCD CLI
        run: |
          VERSION=$(curl --silent "https://api.github.com/repos/argoproj/argo-cd/releases/latest" | grep '"tag_name"' | sed -E 's/.*"([^"]+)".*/\1/')
          curl -sSL -o /tmp/argocd-linux-amd64 "https://github.com/argoproj/argo-cd/releases/download/${VERSION}/argocd-linux-amd64"
          sudo install -m 555 /tmp/argocd-linux-amd64 /usr/local/bin/argocd
          rm /tmp/argocd-linux-amd64

      - name: Add Git repository to ArgoCD
        env:
          ARGOCD_SERVER: ${{ "{{" }} secrets.ARGOCD_SERVER {{ "}}" }}
          ARGOCD_AUTH_TOKEN: ${{ "{{" }} secrets.ARGOCD_AUTH_TOKEN {{ "}}" }}
          GITHUB_TOKEN: ${{ "{{" }} secrets.ARGOCD_GITHUB_TOKEN {{ "}}" }}
        run: |
          REPO_URL="https://github.com/backstage-beach/${{ "{{" }} github.event.repository.name {{ "}}" }}"
          
          # Add repo (idempotent check not strictly needed if we assume failure means exists, or we can list)
          # Using --upsert to handle updates
          argocd repo add "$REPO_URL" \
            --username git \
            --password "$GITHUB_TOKEN" \
            --insecure-skip-server-verification \
            --upsert \
            --grpc-web

      - name: Create ArgoCD Application
        env:
          ARGOCD_SERVER: ${{ "{{" }} secrets.ARGOCD_SERVER {{ "}}" }}
          ARGOCD_AUTH_TOKEN: ${{ "{{" }} secrets.ARGOCD_AUTH_TOKEN {{ "}}" }}
        run: |
          REPO_URL="https://github.com/backstage-beach/${{ "{{" }} github.event.repository.name {{ "}}" }}"
          
          argocd app create "${{ "{{" }} env.APP_NAME {{ "}}" }}" \
            --repo "$REPO_URL" \
            --path "charts/${{ "{{" }} env.APP_NAME {{ "}}" }}" \
            --dest-server https://kubernetes.default.svc \
            --dest-namespace "${{ "{{" }} env.NAMESPACE {{ "}}" }}" \
            --revision HEAD \
            --sync-policy automated \
            --sync-option CreateNamespace=true \
            --auto-prune \
            --self-heal \
            --upsert \
            --grpc-web

      - name: Sync ArgoCD Application
        env:
          ARGOCD_SERVER: ${{ "{{" }} secrets.ARGOCD_SERVER {{ "}}" }}
          ARGOCD_AUTH_TOKEN: ${{ "{{" }} secrets.ARGOCD_AUTH_TOKEN {{ "}}" }}
        run: |
          argocd app sync "${{ "{{" }} env.APP_NAME {{ "}}" }}" --prune --grpc-web
          argocd app wait "${{ "{{" }} env.APP_NAME {{ "}}" }}" --health --timeout 300 --grpc-web

      - name: Verify deployment
        env:
          ARGOCD_SERVER: ${{ "{{" }} secrets.ARGOCD_SERVER {{ "}}" }}
          ARGOCD_AUTH_TOKEN: ${{ "{{" }} secrets.ARGOCD_AUTH_TOKEN {{ "}}" }}
        run: |
          echo "### ðŸš€ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Application**: \`${{ "{{" }} env.APP_NAME {{ "}}" }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Namespace**: \`${{ "{{" }} env.NAMESPACE {{ "}}" }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ArgoCD**: [View Application](https://${{ "{{" }} secrets.ARGOCD_SERVER {{ "}}" }}/applications/${{ "{{" }} env.APP_NAME {{ "}}" }})" >> $GITHUB_STEP_SUMMARY
          
          argocd app get "${{ "{{" }} env.APP_NAME {{ "}}" }}" --grpc-web
